<% layout("./layouts/boilerplate") %>

<div class="container my-5">
  <h1 class="mb-4 text-center fw-bold text-primary">Edit Stay Listing</h1>
  <p class="text-center text-muted mb-5">Update your property details below.</p>

  <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" class="needs-validation" novalidate enctype="multipart/form-data">
    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5">

          <!-- Title -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Title *</label>
            <input class="form-control form-control-lg" name="listing[title]" type="text" value="<%= listing.title %>" required>
            <div class="invalid-feedback">Please enter a title for your listing.</div>
          </div>

          <!-- Description -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Description *</label>
            <textarea class="form-control" name="listing[description]" rows="4" required><%= listing.description %></textarea>
            <div class="invalid-feedback">Please provide a description.</div>
          </div>

          <!-- Images -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Featured Image</label>
              <% if(listing.featuredImage && listing.featuredImage.url){ %>
                <img src="<%= listing.featuredImage.url %>" width="200" class="img-thumbnail mb-2"><br>
              <% } %>
              <input class="form-control" name="listing[featuredImage]" type="file" accept="image/*">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Additional Images</label>
              <% if(listing.images && listing.images.length > 0){ %>
                <div class="d-flex flex-wrap mb-2">
                  <% listing.images.forEach(img => { %>
                    <% if(img && img.url){ %>
                      <img src="<%= img.url %>" width="120" class="img-thumbnail me-2 mb-2">
                    <% } %>
                  <% }) %>
                </div>
              <% } %>
              <input class="form-control" name="listing[images]" type="file" accept="image/*" multiple>
            </div>
          </div>

          <!-- Price -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Price (per Day, ₹) *</label>
            <div class="input-group">
              <span class="input-group-text">₹</span>
              <input class="form-control" name="listing[price]" type="number"  value="<%= listing.price %>" required>
            </div>
          </div>

          <!-- Location -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Country *</label>
              <input class="form-control" name="listing[country]" type="text" value="<%= listing.country || 'India' %>" required>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">City *</label>
              <input class="form-control" name="listing[city]" type="text" value="<%= listing.city %>" required>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Pincode *</label>
              <input class="form-control" name="listing[pincode]" type="text" value="<%= listing.pincode || '' %>" pattern="\d{6}" required>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Locality / Area *</label>
              <input class="form-control" name="listing[area]" type="text" value="<%= listing.area %>" required>
            </div>
          </div>

          <!-- Property Type & BHK -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Property Type *</label>
              <select class="form-select" name="listing[propertyType]" id="propertyType" required>
                <option value="">Select Property Type</option>
                <option value="Flat" <%= listing.propertyType === "Flat" ? "selected" : "" %>>Flat / Apartment</option>
                <option value="PG" <%= listing.propertyType === "PG" ? "selected" : "" %>>PG / Paying Guest</option>
                <option value="Studio" <%= listing.propertyType === "Studio" ? "selected" : "" %>>Studio / 1RK</option>
              </select>
            </div>
            <div class="col-md-6" id="bhkContainer">
              <label class="form-label fw-semibold">BHK Type *</label>
              <select class="form-select" name="listing[bhkType]" id="bhkType">
                <option value="">Select BHK Type</option>
                <option value="1BHK" <%= listing.bhkType === "1BHK" ? "selected" : "" %>>1BHK</option>
                <option value="2BHK" <%= listing.bhkType === "2BHK" ? "selected" : "" %>>2BHK</option>
                <option value="3BHK" <%= listing.bhkType === "3BHK" ? "selected" : "" %>>3BHK</option>
                <option value="More" <%= listing.bhkType === "More" ? "selected" : "" %>>More</option>
              </select>
            </div>
          </div>

          <!-- Bedrooms & Bathrooms -->
          <div class="row g-3 mb-4" id="bedBathContainer">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Bedrooms *</label>
              <input class="form-control" type="number" name="listing[bedrooms]" id="bedroomsInput" min="1" value="<%= listing.bedrooms || '' %>">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Bathrooms *</label>
              <input class="form-control" type="number" name="listing[bathrooms]" id="bathroomsInput" min="1" value="<%= listing.bathrooms || '' %>">
            </div>
          </div>

          <!-- Amenities -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Amenities</label>
            <div class="d-flex flex-wrap gap-3">
              <% const allAmenities = ["WiFi","AC","Parking"]; %>
              <% allAmenities.forEach(a => { %>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="listing[amenities][]" value="<%= a %>" <%= listing.amenities && listing.amenities.includes(a) ? "checked" : "" %>>
                  <label class="form-check-label"><%= a %></label>
                </div>
              <% }) %>
            </div>
          </div>

          <!-- Additional Info -->
          <div class="mb-4">
            <label class="form-label fw-semibold">House Rules / Additional Info</label>
            <textarea class="form-control" name="listing[additionalInfo]" rows="3"><%= listing.additionalInfo || '' %></textarea>
          </div>

          <!-- Map -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Property Location *</label>
            <input class="form-control mb-2" id="locationInput" type="text" placeholder="Search for your property location..." value="<%= listing.mapLink || '' %>">
            <div id="map" style="width:100%; height:400px; border-radius:0.5rem;"></div>
            <input type="hidden" name="listing[latitude]" id="latitude" value="<%= listing.latitude || '' %>" required>
            <input type="hidden" name="listing[longitude]" id="longitude" value="<%= listing.longitude || '' %>">
          </div>

          <!-- Submit -->
          <div class="text-center mt-4">
            <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" type="submit">
              <i class="fa-solid fa-paper-plane me-2"></i> Save Changes
            </button>
          </div>

        </div>
      </div>
    </div>
  </form>
</div>

<script>
const propertyType = document.getElementById('propertyType');
const bhkContainer = document.getElementById('bhkContainer');
const bhkType = document.getElementById('bhkType');
const bedBathContainer = document.getElementById('bedBathContainer');
const bedroomsInput = document.getElementById('bedroomsInput');
const bathroomsInput = document.getElementById('bathroomsInput');

function toggleFields() {
  const type = propertyType.value;
  if(type === "Flat") {
    bhkContainer.style.display = "block";
    bhkType.required = true;
    bedBathContainer.style.display = "flex";
    bhkType.dispatchEvent(new Event('change'));
  } else {
    bhkContainer.style.display = "none";
    bhkType.required = false;
    bedBathContainer.style.display = "none";
    bedroomsInput.value = "";
    bathroomsInput.value = "";
    bedroomsInput.readOnly = false;
    bathroomsInput.readOnly = false;
  }
}

// Auto-fill bedroom/bathroom based on BHK
bhkType.addEventListener('change', () => {
  const bhk = bhkType.value;
  switch(bhk) {
    case "1BHK": bedroomsInput.value = bathroomsInput.value = 1; break;
    case "2BHK": bedroomsInput.value = bathroomsInput.value = 2; break;
    case "3BHK": bedroomsInput.value = bathroomsInput.value = 3; break;
    default: bedroomsInput.value = bathroomsInput.value = ""; break;
  }
  bedroomsInput.readOnly = bathroomsInput.readOnly = ["1BHK","2BHK","3BHK"].includes(bhk);
});

propertyType.addEventListener('change', toggleFields);
window.addEventListener('load', toggleFields);
</script>

<script>
async function getGeoapifyKey() {
  const res = await fetch('/api/geoapify-key');
  const data = await res.json();
  return data.apiKey;
}

(async () => {
  const apiKey = await getGeoapifyKey();
  const lat = parseFloat(document.getElementById('latitude').value) || 21.1458;
  const lon = parseFloat(document.getElementById('longitude').value) || 79.0882;

  const map = L.map('map').setView([lat, lon], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let marker = L.marker([lat, lon], { draggable: true }).addTo(map);
  marker.on('dragend', e => {
    const pos = e.target.getLatLng();
    document.getElementById('latitude').value = pos.lat;
    document.getElementById('longitude').value = pos.lng;
  });

  const input = document.getElementById('locationInput');
  input.addEventListener('input', async () => {
    if (!input.value) return;
    const res = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(input.value)}&limit=5&apiKey=${apiKey}`);
    const features = (await res.json()).features;
    if (features.length === 0) return;
    const [lon, lat] = features[0].geometry.coordinates;
    marker.setLatLng([lat, lon]);
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;
    map.setView([lat, lon], 15);
  });

  // Optional: use browser geolocation to set initial position
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      if (!document.getElementById('latitude').value) {
        marker.setLatLng([latitude, longitude]);
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
        map.setView([latitude, longitude], 15);
      }
    });
  }
})();
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.card { background: #fff; border-radius: 1rem; }
.form-control, .form-select { border-radius: 0.5rem; padding: 0.75rem 1rem; border:1px solid #dee2e6; transition:0.3s; }
.form-control:focus, .form-select:focus { border-color:#0d6efd; box-shadow:0 0 0 0.25rem rgba(13,110,253,.25); }
.form-label { color:#333; margin-bottom:0.5rem; }
.btn-primary { background: linear-gradient(135deg, #156ef3, #2f85ff); border:none; transition: transform 0.2s, box-shadow 0.2s; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(21,110,243,0.4); }
</style>
