<% layout("./layouts/boilerplate") %>

<style>
  body { background-color: #f0f4f8; font-family: 'Segoe UI', sans-serif; }
  .profile-container { padding: 3rem 1rem; }

  /* General Cards */
  .profile-card, .management-section, .dashboard-section {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    padding: 2rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .profile-card:hover, .management-section:hover, .dashboard-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
  }

  /* Profile Image */
  .profile-img {
    width: 160px; height: 160px; border-radius: 50%;
    object-fit: cover; border: 4px solid #ccd6f6; margin-bottom: 1.5rem;
    transition: transform 0.3s ease, border-color 0.3s ease;
  }
  .profile-img:hover { transform: scale(1.05); border-color: #008cff; }

  /* Profile Details */
  .card-title { font-size: 2rem; font-weight: 600; color: #008cff; margin-bottom: 1rem; }
  .profile-detail { font-size: 1rem; margin: 0.4rem 0; }
  .profile-detail strong { color: #008cff; margin-right: 0.5rem; }

  /* Edit Button */
  .btn-edit {
    margin-top: 1.5rem;
    border-radius: 50px;
    padding: 0.6rem 1.8rem;
    font-weight: 500;
    background: linear-gradient(90deg, #008cff, #00d4ff);
    color: #fff;
    border: none;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-edit:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,140,255,0.3);
    background: linear-gradient(90deg, #006fcc, #00b8e6);
  }

  /* Management Section */
  .management-section h4, .dashboard-section h4 { color: #008cff; margin-bottom: 1rem; }

  .action-btn {
    width: 100%; display: flex; justify-content: space-between; align-items: center;
    padding: 0.9rem 1.2rem;
    border-radius: 0.75rem;
    border: none; font-size: 1rem; font-weight: 500;
    color: #333; background: #f5f6fa; margin-bottom: 0.8rem;
    cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 12px rgba(0,0,0,0.06);
    text-decoration: none;
  }
  .action-btn i:first-child { color: #008cff; font-size: 1.2rem; transition: color 0.3s ease, transform 0.3s ease; }
  .action-btn:hover {
    background: linear-gradient(90deg, #008cff, #00d4ff);
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,140,255,0.25);
  }
  .action-btn:hover i:first-child { color: #fff; transform: scale(1.2); }
  .action-btn i:last-child { transition: transform 0.3s ease; }
  .action-btn:hover i:last-child { transform: translateX(5px); }

  /* Dashboard Metrics & Meters */
  .metric-card, .meter-card {
    text-align: center;
    padding: 1rem;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    margin: 0.5rem;
    max-width: 12rem;
    flex: 1 1 auto;
  }
  .metric-card h6, .meter-card h6 { margin-bottom: 0.5rem; color: #008cff; font-weight: 600; }
  .metric-card p { font-size: 1.5rem; font-weight: 600; margin: 0; }

  @media (max-width: 768px) {
    .profile-container { padding: 2rem 0.5rem; }
    .profile-img { width: 130px; height: 130px; }
    .metric-card, .meter-card { max-width: 100%; }
  }
</style>

<div class="profile-container">
  <div class="row justify-content-center g-4">

    <!-- Profile Card -->
    <div class="col-md-5">
      <div class="profile-card text-center">
        <img src="<%= user.avatar || 'https://placehold.co/400x400/ececec/008cff' %>" class="profile-img" alt="<%= user.username %>">
        <h5 class="card-title"><%= user.username %></h5>
        <div class="profile-detail"><strong>Email:</strong> <span><%= user.email %></span></div>
        <div class="profile-detail"><strong>Joined:</strong> <span><%= user.createdAt ? new Date(user.createdAt).toDateString() : "N/A" %></span></div>
        <a href="/users/profile/edit" class="btn btn-edit"><i class="fas fa-pencil-alt me-2"></i>Edit Profile</a>
      </div>
    </div>

    <!-- Management Section -->
    <div class="col-md-5">
      <div class="management-section">
        <h4><i class="fas fa-tasks me-2"></i> Management</h4>
        <h6 class="mt-3"><strong>Host Actions</strong></h6>
        <a href="/users/host/properties" class="action-btn"><span><i class="fas fa-home me-2"></i>All Listed Properties</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/host/bookings/upcoming" class="action-btn"><span><i class="fas fa-door-open me-2"></i>Upcoming Guests</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/host/bookings/history" class="action-btn"><span><i class="fas fa-history me-2"></i>Past Guests</span><i class="fas fa-chevron-right"></i></a>

        <h6 class="mt-3"><strong>Guest Actions</strong></h6>
        <a href="/users/guest/bookings/upcoming" class="action-btn"><span><i class="fas fa-suitcase me-2"></i>Upcoming Stays</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/guest/wishlist" class="action-btn"><span><i class="fas fa-heart me-2"></i>Wishlist</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/guest/bookings/history" class="action-btn"><span><i class="fas fa-history me-2"></i>Booking History</span><i class="fas fa-chevron-right"></i></a>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div class="col-12 mt-5">
      <div class="dashboard-section">
        <h4><i class="fas fa-tachometer-alt me-2"></i> Dashboard</h4>

        <!-- Combined Metrics Row -->
        <div class="d-flex flex-wrap justify-content-center mt-3">
          <div class="metric-card"><h6>Total Properties</h6><p class="text-primary"><%= dashboard.owner.totalProperties || 0 %></p></div>
          <div class="metric-card"><h6>Pending Bookings</h6><p class="text-warning"><%= dashboard.owner.pendingBookings || 0 %></p></div>
          <div class="metric-card"><h6>Upcoming Check-ins</h6><p class="text-success"><%= dashboard.owner.upcomingCheckins || 0 %></p></div>
          <div class="metric-card"><h6>Total Revenue</h6><p class="text-danger">$<%= dashboard.owner.totalRevenue || 0 %></p></div>
          <div class="metric-card"><h6>Upcoming Stays</h6><p class="text-info"><%= dashboard.guest.upcoming || 0 %></p></div>
          <div class="metric-card"><h6>Completed Stays</h6><p class="text-success"><%= dashboard.guest.completed || 0 %></p></div>
          <div class="metric-card"><h6>Total Bookings</h6><p class="text-primary"><%= dashboard.guest.totalBookings || 0 %></p></div>
          <div class="metric-card"><h6>Pending %</h6><p class="text-warning"><%= dashboard.owner.pendingBookingsPercent || 0 %>%</p></div>
        </div>

        <!-- Meters Row -->
        <div class="d-flex flex-wrap justify-content-center mt-4">
          <div class="meter-card"><h6>Total Revenue</h6><canvas id="revenueMeter" width="85" height="85"></canvas></div>
          <div class="meter-card"><h6>Occupancy Rate</h6><canvas id="occupancyMeter" width="85" height="85"></canvas></div>
          <div class="meter-card"><h6>Completed Stays</h6><canvas id="completedMeter" width="85" height="85"></canvas></div>
          <div class="meter-card"><h6>Pending %</h6><canvas id="pendingMeter" width="85" height="85"></canvas></div>
        </div>

        <!-- Charts -->
        <div class="row mt-4">
          <div class="col-md-6"><canvas id="revenueChart"></canvas></div>
          <div class="col-md-6"><canvas id="occupancyChart"></canvas></div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- Add a hidden container with JSON data -->
<div id="dashboardData" data-json='<%= JSON.stringify(dashboard || {}) %>' style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Parse dashboard data from the hidden container
  const dashboardElement = document.getElementById('dashboardData');
  const dashboardData = JSON.parse(dashboardElement.dataset.json || '{}');

  function createMeter(id, value, gradientColors) {
    const ctx = document.getElementById(id).getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 150);
    gradient.addColorStop(0, gradientColors[0]);
    gradient.addColorStop(1, gradientColors[1]);

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Used','Remaining'],
        datasets: [{
          data: [value, 100 - value],
          backgroundColor: [gradient, '#eee'],
          borderWidth: 2,
          hoverOffset: 10
        }]
      },
      options: {
        cutout: '65%',
        plugins: { legend: { display: false }, tooltip: { enabled: false } }
      }
    });
  }

  const totalRevenuePct = Math.min((dashboardData.owner?.totalRevenue || 0)/1000, 100);
  const occupancyPct = Math.min(dashboardData.owner?.occupancyRate || 50, 100);
  const completedPct = dashboardData.guest?.totalBookings
    ? ((dashboardData.guest.totalBookings - dashboardData.owner.pendingBookings) / dashboardData.guest.totalBookings) * 100
    : 0;
  const pendingPct = 100 - completedPct;

  createMeter('revenueMeter', totalRevenuePct, ['#008cff','#00d4ff']);
  createMeter('occupancyMeter', occupancyPct, ['#28a745','#85e085']);
  createMeter('completedMeter', completedPct, ['#6f42c1','#b38ffb']);
  createMeter('pendingMeter', pendingPct, ['#fd7e14','#ffbb66']);

  // Revenue Line Chart
  new Chart(document.getElementById('revenueChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: dashboardData.owner?.revenueLabels || [],
      datasets: [{
        label: 'Revenue',
        data: dashboardData.owner?.revenueData || [],
        borderColor: '#008cff',
        backgroundColor: 'rgba(0,140,255,0.2)',
        fill: true
      }]
    },
    options: { responsive: true, plugins: { legend: { display: true } } }
  });

  // Occupancy Bar Chart
  new Chart(document.getElementById('occupancyChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: dashboardData.owner?.occupancyLabels || [],
      datasets: [{
        label: 'Occupancy',
        data: dashboardData.owner?.occupancyData || [],
        backgroundColor: '#008cff'
      }]
    },
    options: { responsive: true, plugins: { legend: { display: true } } }
  });
</script>
