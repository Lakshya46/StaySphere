<% layout("./layouts/boilerplate") %>

<div class="container my-5">
  <div class="booking-card mx-auto shadow-lg border-0 rounded-4 overflow-hidden">

    <!-- Header -->
    <div class="booking-header text-white text-center py-5">
      <h3 class="fw-bold mb-2"><i class="fas fa-receipt me-2"></i>Booking Summary</h3>
      <p class="mb-0 small text-light opacity-75">Thank you for choosing StaySphere</p>
    </div>

    <!-- Body -->
    <div class="booking-body p-4 p-md-5">

      <!-- Listing Image -->
      <% if (booking.listing.featuredImage?.url) { %>
        <div class="text-center mb-4">
          <img src="<%= booking.listing.featuredImage.url %>" 
               alt="<%= booking.listing.title %>"
               class="listing-image shadow-sm rounded-4">
        </div>
      <% } %>

      <!-- Listing Details -->
      <div class="text-center mb-5">
        <h4 class="fw-bold text-primary mb-1"><%= booking.listing.title %></h4>
        <p class="text-muted mb-1">
          <i class="fas fa-map-marker-alt text-danger me-1"></i>
          <%= booking.listing.area %>, <%= booking.listing.city %>, <%= booking.listing.country %>
        </p>
        <% if (booking.listing.pincode) { %>
          <p class="text-muted small mb-0">
            <i class="fas fa-location-pin me-1 text-secondary"></i>
            Pincode: <%= booking.listing.pincode %>
          </p>
        <% } %>
      </div>

      <!-- Booking Info Grid -->
      <div class="row g-4 mb-5 justify-content-center">
        <% const details = [
          { icon: 'fa-user', label: 'Guest Name', value: booking.user.username },
          { icon: 'fa-users', label: 'Guests', value: booking.guests },
          { icon: 'fa-calendar-check', label: 'Check-In', value: booking.startDate.toDateString() },
          { icon: 'fa-calendar-times', label: 'Check-Out', value: booking.endDate.toDateString() },
          { icon: 'fa-money-bill-wave', label: 'Total Price', value: `₹${booking.totalPrice.toLocaleString()}` },
          { icon: 'fa-info-circle', label: 'Status', value: booking.status.charAt(0).toUpperCase() + booking.status.slice(1) }
        ]; %>

        <% details.forEach(d => { %>
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="info-card text-center p-4 rounded-4 shadow-sm h-100">
              <div class="icon-circle mb-3">
                <i class="fas <%= d.icon %>"></i>
              </div>
              <h6 class="fw-semibold text-dark"><%= d.label %></h6>
              <p class="fw-bold text-secondary mb-0"><%= d.value %></p>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- Contact Info -->
      <div class="text-center mb-5">
        <% if (booking.listing.owner._id.equals(currentUser._id)) { %>
          <h5 class="fw-bold text-dark mb-3"><i class="fas fa-user me-2 text-primary"></i>Guest Contact Info</h5>
          <div class="contact-info d-flex justify-content-center gap-4 flex-wrap">
            <% if (booking.user?.email) { %>
              <div class="contact-item">
                <i class="fas fa-envelope me-2 text-primary"></i>
                <a href="mailto:<%= booking.user.email %>" class="text-decoration-none text-dark"><%= booking.user.email %></a>
              </div>
            <% } %>
            <% if (booking.user?.phone) { %>
              <div class="contact-item">
                <i class="fas fa-phone me-2 text-success"></i>
                <a href="tel:<%= booking.user.phone %>" class="text-decoration-none text-dark"><%= booking.user.phone %></a>
              </div>
            <% } %>
          </div>
        <% } else { %>
          <h5 class="fw-bold text-dark mb-3"><i class="fas fa-user-tie me-2 text-primary"></i>Host Contact Info</h5>
          <div class="contact-info d-flex justify-content-center gap-4 flex-wrap">
            <% if (booking.listing.owner?.email) { %>
              <div class="contact-item">
                <i class="fas fa-envelope me-2 text-primary"></i>
                <a href="mailto:<%= booking.listing.owner.email %>" class="text-decoration-none text-dark"><%= booking.listing.owner.email %></a>
              </div>
            <% } %>
            <% if (booking.listing.owner?.phone) { %>
              <div class="contact-item">
                <i class="fas fa-phone me-2 text-success"></i>
                <a href="tel:<%= booking.listing.owner.phone %>" class="text-decoration-none text-dark"><%= booking.listing.owner.phone %></a>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>

      <!-- Actions -->
      <div class="d-flex flex-wrap justify-content-center gap-3">
        <a href="/listings/<%= booking.listing._id %>" class="btn btn-outline-primary px-4 rounded-pill shadow-sm">
          <i class="fas fa-arrow-left me-2"></i> Back
        </a>

        <% if (booking.status === "pending") { %>
          <button id="rzp-button" type="button" class="btn btn-primary px-4 rounded-pill shadow-sm">
            <i class="fas fa-credit-card me-2"></i> Pay Now
          </button>
        <% } else if (booking.status === "confirmed") { %>
          <button class="btn btn-success px-4 rounded-pill shadow-sm" disabled>
            <i class="fas fa-check-circle me-2"></i> Paid & Confirmed
          </button>
        <% } %>

        <% if (booking.status !== "cancelled") { %>
          <form method="POST" action="/listings/<%= booking.listing._id %>/booking/<%= booking._id %>?_method=DELETE">
            <button type="submit" class="btn btn-danger px-4 rounded-pill shadow-sm">
              <i class="fas fa-times-circle me-2"></i> Cancel Booking
            </button>
          </form>
        <% } %>
      </div>

    </div>
  </div>
</div>

<style>
body {
  background: linear-gradient(135deg, #eef5ff, #ffffff);
  font-family: 'Poppins', sans-serif;
}
.booking-card { max-width: 950px; background: #fff; border-radius: 22px; }
.booking-header { background: linear-gradient(90deg, #007bff, #00bfff); }
.listing-image { width: 100%; height: 280px; object-fit: cover; border-radius: 15px; }
.info-card { background: #f9fbff; transition: all 0.3s; }
.info-card:hover { transform: translateY(-5px); background: #f1f7ff; }
.icon-circle {
  width: 55px; height: 55px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem; color: #007bff; background: #e9f2ff;
}
.contact-item {
  background: #f8f9fa; border-radius: 10px;
  padding: 8px 15px; transition: 0.2s;
}
.contact-item:hover {
  background: #e7f1ff;
  transform: translateY(-3px);
}
@media (max-width: 768px) {
  .booking-body { padding: 2rem 1rem; }
  .listing-image { height: 200px; }
  .icon-circle { width: 45px; height: 45px; font-size: 1rem; }
}
</style>

<!-- ✅ Razorpay Payment Integration -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById("rzp-button")?.addEventListener("click", async () => {
  try {
    const RAZORPAY_KEY = "<%= process.env.RAZORPAY_KEY_ID %>";
    if (!RAZORPAY_KEY || RAZORPAY_KEY === "YOUR_TEST_KEY_ID") {
      await fetch(`/listings/<%= booking.listing._id %>/booking/<%= booking._id %>/pay`, { method: "POST" });
      window.location.reload();
      return;
    }

    const res = await fetch(`/bookings/<%= booking._id %>/razorpay-order`, { method: "POST" });
    if (!res.ok) throw new Error("Failed to create Razorpay order");

    const { order, booking: bookingData } = await res.json();

    const options = {
      key: RAZORPAY_KEY,
      amount: order.amount,
      currency: order.currency,
      name: bookingData.listing.title,
      description: "Booking Payment",
      order_id: order.id,
      handler: async (response) => {
        const verifyRes = await fetch(`/bookings/<%= booking._id %>/verify-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(response),
        });
        const data = await verifyRes.json();
        if (data.success) {
          alert("✅ Payment successful!");
          window.location.reload();
        } else alert("❌ Payment verification failed!");
      },
      theme: { color: "#008cff" },
    };
    new Razorpay(options).open();
  } catch (err) {
    console.error("Payment error:", err);
    alert("Payment failed. Check console.");
  }
});
</script>
