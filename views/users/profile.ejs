<% layout("./layouts/boilerplate") %>

<style>
  body { background-color: #f0f2f8; font-family: 'Segoe UI', sans-serif; }
  .profile-container { max-width: 1200px; margin:auto; padding:2rem 1rem; }

  /* Profile Card */
  .profile-card {
    background: linear-gradient(145deg,#fff,#ffffff);
    border-radius: 1rem; padding:2rem 1rem;
    text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s;
    margin-bottom:1rem;
  }
  .profile-card:hover { transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,0.12); }
  .profile-img { width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid #008cff; margin-bottom:1rem; transition: transform 0.3s, border-color 0.3s; }
  .profile-img:hover { transform:scale(1.05); border-color:#00d4ff; }
  .card-title { font-size:1.6rem; font-weight:600; color:#008cff; margin-bottom:0.5rem; }
  .profile-detail { font-size:1rem; margin:0.4rem 0; }
  .profile-detail strong { color:#008cff; }
  .btn-edit {
    margin-top:1rem; padding:0.5rem 1.5rem; border-radius:50px;
    background: linear-gradient(90deg,#008cff,#00d4ff); color:#fff;
    font-weight:500; text-decoration:none; display:inline-block;
    transition: all 0.3s;
  }
  .btn-edit:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,140,255,0.3); }

  /* Management Section */
  .management-section {
    background: linear-gradient(145deg,#fff,#ffffff);
    border-radius: 1rem; padding:2rem 1rem;
    box-shadow:0 8px 25px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s;
    margin-bottom:1rem;
  }
  .management-section:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.12); }
  .management-section h4 { color:#008cff; margin-bottom:1.2rem; font-size:1.3rem; }
  .action-btn {
    display:flex; justify-content:space-between; align-items:center;
    background:#f5f6fa; color:#333; padding:0.8rem 1rem; border-radius:0.75rem;
    margin-bottom:0.6rem; font-weight:500; text-decoration:none; transition: all 0.3s;
    box-shadow:0 4px 15px rgba(0,0,0,0.06);
  }
  .action-btn i:first-child { color:#008cff; font-size:1.2rem; }
  .action-btn:hover { background: linear-gradient(90deg,#008cff,#00d4ff); color:#fff; transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,140,255,0.25); }
  .action-btn:hover i:first-child { color:#fff; transform:scale(1.2); }
  .action-btn i:last-child { transition: transform 0.3s ease; }
  .action-btn:hover i:last-child { transform: translateX(5px); }

  /* Metrics Row */
  .metrics-row {
    display:flex; flex-wrap:wrap; gap:0.8rem; margin-top:1.5rem;
  }
  .metric-card {
    flex:1 1 calc(20% - 0.5rem);
    background: linear-gradient(145deg,#fff,#f7f9fc);
    border-radius:1rem; padding:1.2rem; text-align:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.06); cursor:pointer; transition:all 0.3s;
  }
  .metric-card:hover { transform:translateY(-3px); box-shadow:0 12px 25px rgba(0,0,0,0.12); }
  .metric-card h6 { margin-bottom:0.4rem; color:#008cff; font-weight:600; font-size:1rem; }
  .metric-card p { font-size:1.5rem; font-weight:600; margin:0; }

  /* Charts Row */
  .charts-row {
    display:flex; flex-wrap:wrap; gap:2rem; justify-content:center; margin-top:2rem;
  }
  .meter-card, .revenue-charts {
    flex:1 1 300px; background:#fff; border-radius:1rem; padding: 1rem; text-align:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.06); transition:all 0.3s;
  }
  .meter-card:hover, .revenue-charts:hover { transform:translateY(-1px); box-shadow:0 12px 30px rgba(0,0,0,0.12); }
  .meter-card h6, .revenue-charts h6 { color:#008cff; font-weight:600; margin-bottom:1rem; }
  .meter-card canvas, .revenue-charts canvas { width:100% !important; height:280px !important; }
  .meter-card {
  padding: 0.5rem;   /* reduce outer padding */
}


.meter-card canvas {
  height: 180px !important;  /* reduce chart height */
  width: 180px !important;  
   margin: 0 auto;          /* ensure canvas is centered */
  display: block; /* reduce width */
}

  

  @media (max-width: 768px) {
  .meter-card canvas {
    width: 260px !important;
    height: 260px !important;
  }
  
}
</style>


<div class="profile-container">
  <div class="row g-4 justify-content-center">

    <!-- Profile Card -->
    <div class="col-md-4">
      <div class="profile-card">
        <img src="<%= user.avatar || 'https://placehold.co/400x400/ececec/008cff' %>" class="profile-img" alt="<%= user.username %>">
        <h5 class="card-title"><%= user.username %></h5>
        <div class="profile-detail"><strong>Email:</strong> <%= user.email %></div>
        <div class="profile-detail"><strong>Joined:</strong> <%= user.createdAt ? new Date(user.createdAt).toDateString() : "N/A" %></div>
        <div class="profile-detail"><strong>Phone:</strong> <%= user.phone || "N/A" %></div>
        <div class="profile-detail"><strong>Address:</strong> <%= user.address || "N/A" %></div>
        <a href="/users/profile/edit" class="btn-edit"><i class="fas fa-pencil-alt me-2"></i>Edit Profile</a>
      </div>
    </div>

    <!-- Management Section -->
    <div class="col-md-5">
      <div class="management-section">
        <h4><i class="fas fa-tasks me-2"></i> Management</h4>
        <h6 class="mt-3"><strong>Host Actions</strong></h6>
        <a href="/users/host/properties" class="action-btn"><span><i class="fas fa-home me-2"></i>All Properties</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/host/bookings/upcoming" class="action-btn"><span><i class="fas fa-door-open me-2"></i>Upcoming Guests</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/host/bookings/history" class="action-btn"><span><i class="fas fa-history me-2"></i>Past Guests</span><i class="fas fa-chevron-right"></i></a>

        <h6 class="mt-3"><strong>Guest Actions</strong></h6>
        <a href="/users/guest/bookings/upcoming" class="action-btn"><span><i class="fas fa-suitcase me-2"></i>Upcoming Stays</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/guest/wishlist" class="action-btn"><span><i class="fas fa-heart me-2"></i>Wishlist</span><i class="fas fa-chevron-right"></i></a>
        <a href="/users/guest/bookings/history" class="action-btn"><span><i class="fas fa-history me-2"></i>Booking History</span><i class="fas fa-chevron-right"></i></a>
      </div>
    </div>

    <!-- Metrics Row -->
    <div class="col-12 mt-2">
      <div class="metrics-row">
        <div class="metric-card" onclick="window.location.href='/users/host/properties'">
          <h6>Total Properties</h6>
          <p class="text-primary"><%= dashboard.owner.totalProperties || 0 %></p>
        </div>
        <div class="metric-card" onclick="window.location.href='/users/host/bookings/upcoming'">
          <h6>Pending Bookings</h6>
          <p class="text-warning"><%= dashboard.owner.pendingBookings || 0 %></p>
        </div>
        <div class="metric-card">
          <h6>Upcoming Check-ins</h6>
          <p class="text-success"><%= dashboard.owner.upcomingCheckins || 0 %></p>
        </div>
        
        <div class="metric-card">
          <h6>Cancelled Bookings</h6>
          <p class="text-danger"><%= dashboard.owner.cancelledBookings || 0 %></p>
        </div>
        <div class="metric-card">
          <h6>Total Revenue</h6>
          <p class="text-danger">₹<%= dashboard.owner.totalRevenue || 0 %></p>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="col-12 mt-3">
      <div class="charts-row">
        <div class="meter-card">
          <h6>Occupancy Rate</h6>
          <canvas id="occupancyMeter"></canvas>
        </div>
        <div class="meter-card">
          <h6>Completed Stays</h6>
          <canvas id="completedMeter"></canvas>
        </div>
        <div class="meter-card">
          <h6>Cancelled Bookings</h6>
          <canvas id="cancelledMeter"></canvas>
        </div>
      </div>

      <div class="charts-row mt-4">
        <div class="revenue-charts">
          <h6>Revenue % by Property</h6>
          <canvas id="revenuePieChart"></canvas>
        </div>
        <div class="revenue-charts">
          <h6 ">Revenue (₹) by Property</h6>
          <canvas id="revenueBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="dashboardData" data-json='<%= JSON.stringify(dashboard || {}) %>' style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
Chart.register({
  id: 'centerText',
  afterDraw(chart) {
    // Apply ONLY to doughnut charts AND only to meter charts
    const meterIDs = ["occupancyMeter", "completedMeter", "cancelledMeter"];

    if (
      chart.config.type !== "doughnut" ||
      !meterIDs.includes(chart.canvas.id)
    ) return;

    const { ctx, chartArea: { width, height } } = chart;

    const value = chart.config.data.datasets[0].data[0]; // percent value
    const text = value + "%";

    ctx.save();
    ctx.font = "bold 22px Segoe UI";
    ctx.fillStyle = "#333";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, width / 2, height / 2);
    ctx.restore();
  }
});
</script>


<script>
Chart.register({
  id: 'barValueLabels',
  afterDatasetsDraw(chart, args, pluginOptions) {
    const { ctx } = chart;

    chart.data.datasets.forEach((dataset, i) => {
      const meta = chart.getDatasetMeta(i);

      if (!meta.hidden && meta.type === 'bar') {
        meta.data.forEach((bar, index) => {
          const value = dataset.data[index];
          ctx.save();
          ctx.font = 'bold 12px Segoe UI';
          ctx.fillStyle = '#333';
          ctx.textAlign = 'center';
          ctx.fillText(`₹${value}`, bar.x, bar.y - 8);
          ctx.restore();
        });
      }
    });
  }
});
</script>

<script>


document.addEventListener('DOMContentLoaded', function(){
  const dashboardData = JSON.parse(document.getElementById('dashboardData').dataset.json || '{}');

  function createMeter(id,value,colors,label){
    const ctx = document.getElementById(id).getContext('2d');
    const gradient = ctx.createLinearGradient(0,0,0,150);
    gradient.addColorStop(0,colors[0]); gradient.addColorStop(1,colors[1]);
    return new Chart(ctx,{
      type:'doughnut',
      data:{ labels:[label,'Remaining'], datasets:[{data:[value,100-value], backgroundColor:[gradient,'#eee'], borderWidth:1}] },
      options:{ cutout:'70%', plugins:{legend:{display:false}, tooltip:{enabled:true}} }
    });
  }

  createMeter('occupancyMeter', Math.min(dashboardData.owner.occupancyRate||0,100), ['#28a745','#85e085'],'Occupancy');
  createMeter('completedMeter', Math.min(dashboardData.guest.completedPercent||0,100), ['#6f42c1','#b38ffb'],'Completed');
  createMeter('cancelledMeter', Math.min(dashboardData.owner.cancelledPercent||0,100), ['#dc3545','#ff6b6b'],'Cancelled');

  const revenueData = dashboardData.owner.revenueData || [];
  const totalRevenue = revenueData.reduce((sum,val)=>sum+val,0);
  const revenuePercentages = revenueData.map(val => totalRevenue ? ((val/totalRevenue)*100).toFixed(1) : 0);
  const revenueLabels = dashboardData.owner.revenueLabels || [];
  const revenueColors = revenueLabels.map((_,i)=>`hsl(${(i*60)%360},70%,50%)`);

  new Chart(document.getElementById('revenuePieChart'),{
    type:'doughnut',
    data:{
      labels: revenueLabels.map((label,i)=>`${label} (${revenuePercentages[i]}%)`),
      datasets:[{data: revenuePercentages, backgroundColor: revenueColors, borderWidth:2}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      cutout:'60%',
      plugins:{legend:{position:'bottom'}}
    }
  });

  new Chart(document.getElementById('revenueBarChart'), {
    type:'bar',
    data:{
      labels: revenueLabels,
      datasets:[{label:'Revenue (₹)', data: revenueData, backgroundColor:'#008cff'}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}},
       layout: {
    padding: {
      top: 30   
    }
  }
    }
  });
});
</script>
