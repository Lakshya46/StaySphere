<% layout("./layouts/boilerplate") %>

<div class="container my-5">
  <h1 class="mb-4 text-center fw-bold">Edit Stay Listing</h1>

  <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" class="needs-validation" novalidate enctype="multipart/form-data">
    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <div class="card shadow-sm rounded-4 p-4">

          <!-- Title & Description -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Title *</label>
            <input class="form-control form-control-lg" name="listing[title]" type="text" value="<%= listing.title %>" required>
            <div class="invalid-feedback">Please enter a title for your listing.</div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-semibold">Description *</label>
            <textarea class="form-control" name="listing[description]" rows="4" required><%= listing.description %></textarea>
            <div class="invalid-feedback">Please provide a description.</div>
          </div>

          <!-- Featured Image -->
          <div class="mb-3">
            <label class="form-label">Featured Image</label><br>
            <% if(listing.featuredImage && listing.featuredImage.url){ %>
              <img src="<%= listing.featuredImage.url %>" alt="Featured Image" width="200" class="img-thumbnail mb-2"><br>
            <% } %>
            <input class="form-control" name="listing[featuredImage]" type="file" accept="image/*">
            <small class="text-muted">Upload to replace the current featured image.</small>
          </div>

          <!-- Additional Images -->
          <div class="mb-3">
            <label class="form-label">Additional Images</label>
            <% if(listing.images && listing.images.length > 0){ %>
              <div class="d-flex flex-wrap mb-2">
                <% listing.images.forEach(img => { %>
                  <% if(img && img.url){ %>
                    <img src="<%= img.url %>" alt="Listing Image" width="120" class="img-thumbnail me-2 mb-2">
                  <% } %>
                <% }) %>
              </div>
            <% } %>
            <input class="form-control" name="listing[images]" type="file" accept="image/*" multiple>
            <small class="text-muted">Upload new images to add or replace additional images.</small>
          </div>

          <!-- Price & Country -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Price (per month, â‚¹) *</label>
              <input class="form-control" name="listing[price]" type="number" min="1000" value="<%= listing.price %>" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Country *</label>
              <input class="form-control" name="listing[country]" type="text" value="<%= listing.country || "India" %>" required>
            </div>
          </div>

          <!-- City & Area -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">City *</label>
              <input class="form-control" name="listing[city]" type="text" value="<%= listing.city %>" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Locality / Area *</label>
              <input class="form-control" name="listing[area]" type="text" value="<%= listing.area %>" required>
            </div>
          </div>

          <!-- Property Type & BHK Type -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Property Type *</label>
              <select class="form-select" name="listing[propertyType]" required>
                <option value="">Select Property Type</option>
                <option value="Apartment/Flat" <%= listing.propertyType === "Apartment/Flat" ? "selected" : "" %>>Apartment / Flat</option>
                <option value="House" <%= listing.propertyType === "House" ? "selected" : "" %>>Independent House / Villa</option>
                <option value="PG" <%= listing.propertyType === "PG" ? "selected" : "" %>>PG / Paying Guest</option>
                <option value="Homestay" <%= listing.propertyType === "Homestay" ? "selected" : "" %>>Homestay</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">BHK Type *</label>
              <select class="form-select" name="listing[bhkType]" required>
                <option value="">Select BHK Type</option>
                <option value="1BHK" <%= listing.bhkType === "1BHK" ? "selected" : "" %>>1BHK</option>
                <option value="2BHK" <%= listing.bhkType === "2BHK" ? "selected" : "" %>>2BHK</option>
                <option value="3BHK" <%= listing.bhkType === "3BHK" ? "selected" : "" %>>3BHK</option>
                <option value="4BHK+" <%= listing.bhkType === "4BHK+" ? "selected" : "" %>>4BHK or more</option>
                <option value="Studio" <%= listing.bhkType === "Studio" ? "selected" : "" %>>Studio</option>
              </select>
            </div>
          </div>

          <!-- Bedrooms & Bathrooms -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Bedrooms *</label>
              <input class="form-control" type="number" name="listing[bedrooms]" min="1" value="<%= listing.bedrooms %>" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Bathrooms *</label>
              <input class="form-control" type="number" name="listing[bathrooms]" min="1" value="<%= listing.bathrooms %>" required>
            </div>
          </div>

          <!-- Amenities -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Amenities</label><br>
            <% const allAmenities = ["WiFi","AC","Parking"]; %>
            <% allAmenities.forEach(a => { %>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="listing[amenities][]" value="<%= a %>" <%= listing.amenities && listing.amenities.includes(a) ? "checked" : "" %>>
                <label class="form-check-label"><%= a %></label>
              </div>
            <% }) %>
          </div>

          <!-- Additional Info & Map -->
          <div class="mb-4">
            <label class="form-label fw-semibold">House Rules / Additional Info</label>
            <textarea class="form-control" name="listing[additionalInfo]" rows="3"><%= listing.additionalInfo || "" %></textarea>
          </div>

          <div class="mb-4">
            <label class="form-label fw-semibold">Google Maps Link</label>
            <input class="form-control" type="url" name="listing[mapLink]" value="<%= listing.mapLink || "" %>">
          </div>

          <!-- Submit Button -->
          <div class="text-center">
            <button class="btn btn-primary btn-lg px-5" type="submit">Save Changes</button>
          </div>

        </div>
      </div>
    </div>
  </form>
</div>
